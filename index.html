<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anika Kantheti's Half Saree Ceremony</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFBF5;
            color: #4A2E2A;
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        .custom-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .form-input {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus {
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            outline: none;
        }
        .guest-list-item {
            border-left: 4px solid #D4AF37;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">Anika Kantheti's</h1>
            <h2 class="text-3xl md:text-4xl text-amber-700">Half Saree Ceremony</h2>
        </header>

        <!-- Invitation Image -->
        <div class="mb-10 rounded-lg overflow-hidden custom-shadow">
            <img src="https://raw.githubusercontent.com/kankit12/AnikaHalfSareePooja/main/AnikaInvite.jpeg" alt="Invitation for Anika Kantheti's Half Saree Ceremony" class="w-full h-auto">
        </div>

        <!-- Add to Calendar Section -->
        <section id="calendar-section" class="mb-10 p-6 bg-white/50 rounded-lg custom-shadow">
            <h3 class="text-2xl font-bold text-center mb-4 text-amber-900">Save The Date</h3>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <a href="#" id="google-calendar-link" target="_blank" class="btn w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    Add to Google Calendar
                </a>
                <a href="#" id="apple-calendar-link" class="btn w-full sm:w-auto flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-6 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.286 1.5c-1.297 0-2.348.47-3.21 1.32-.863.85-.92 2.08-.92 3.33v10.5c0 1.25.057 2.48.92 3.33.862.85 1.913 1.32 3.21 1.32h7.428c1.297 0 2.348-.47 3.21-1.32.863-.85.92-2.08.92-3.33V6.15c0-1.25-.057-2.48-.92-3.33-.862-.85-1.913-1.32-3.21-1.32H8.286zM12 18.63a1.714 1.714 0 100-3.428 1.714 1.714 0 000 3.428zM12.257 6.3a.214.214 0 00-.214-.214H8.486a.214.214 0 00-.215.214v.429c0 .118.096.214.215.214h3.557a.214.214 0 00.214-.214v-.429z"></path></svg>
                    Add to Apple Calendar
                </a>
            </div>
        </section>

        <!-- RSVP Form Section -->
        <section id="rsvp-section" class="mb-10 p-6 md:p-8 bg-white rounded-lg custom-shadow">
            <h3 class="text-3xl font-bold text-center mb-6 text-amber-900">Kindly RSVP</h3>
            <form id="rsvp-form" class="max-w-lg mx-auto">
                <div class="mb-5">
                    <label for="name" class="block mb-2 text-sm font-medium text-amber-800">Full Name(s)</label>
                    <input type="text" id="name" name="name" class="form-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Amit & Lekha Kantheti" required>
                </div>
                <div class="mb-5">
                    <label class="block mb-2 text-sm font-medium text-amber-800">Will you be attending?</label>
                    <div class="flex gap-4">
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg w-full cursor-pointer hover:bg-green-50">
                            <input type="radio" name="attending" value="Yes" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 focus:ring-green-500" required>
                            <span class="ml-3 text-sm font-medium text-gray-900">Accept</span>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-lg w-full cursor-pointer hover:bg-red-50">
                            <input type="radio" name="attending" value="No" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 focus:ring-red-500">
                            <span class="ml-3 text-sm font-medium text-gray-900">Regretfully Decline</span>
                        </label>
                    </div>
                </div>
                 <div class="mb-6" id="guest-count-wrapper" style="display: none;">
                    <label for="guests" class="block mb-2 text-sm font-medium text-amber-800">Number of Guests (including yourself)</label>
                    <input type="number" id="guests" name="guests" class="form-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" value="1" min="1" max="10">
                </div>
                <button type="submit" id="submit-button" class="btn w-full text-white bg-amber-800 hover:bg-amber-900 focus:ring-4 focus:outline-none focus:ring-amber-300 font-medium rounded-lg text-sm px-5 py-3 text-center">Submit RSVP</button>
            </form>
            <div id="form-message" class="mt-4 text-center font-medium"></div>
        </section>

        <!-- Guest List Section -->
        <section id="guest-list-section" class="p-6 md:p-8 bg-white/70 rounded-lg custom-shadow">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-amber-900">Guest List</h3>
                <button id="toggle-guest-list" class="text-sm text-amber-700 hover:underline">Show List</button>
            </div>
            <div id="guest-list-content" class="hidden">
                <div class="bg-amber-100/50 p-4 rounded-lg mb-4 text-center">
                    <p class="text-lg font-semibold text-amber-900">Total Attending: <span id="total-attending">0</span></p>
                </div>
                <div id="guest-list-container" class="space-y-3">
                    <p class="text-center text-gray-500">Authenticating to see guest list...</p>
                </div>
            </div>
        </section>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyADlqsxQg6Fel95c2GwBG7MHc6wd3tamO0",
          authDomain: "anika-rsvp.firebaseapp.com",
          projectId: "anika-rsvp",
          storageBucket: "anika-rsvp.appspot.com",
          messagingSenderId: "18132588378",
          appId: "1:18132588378:web:74c9cc6ef963c24db34563",
          measurementId: "G-0H29E1HKT9"
        };
        const RSVP_COLLECTION = `rsvps`;

        // --- DOM ELEMENTS ---
        const rsvpForm = document.getElementById('rsvp-form');
        const formMessage = document.getElementById('form-message');
        const guestCountWrapper = document.getElementById('guest-count-wrapper');
        const attendingRadios = document.querySelectorAll('input[name="attending"]');
        const guestListContainer = document.getElementById('guest-list-container');
        const totalAttendingEl = document.getElementById('total-attending');
        const toggleGuestListBtn = document.getElementById('toggle-guest-list');
        const guestListContent = document.getElementById('guest-list-content');
        
        // --- INITIALIZATION ---
        let db, auth;
        let unsubscribeFromRsvps = null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            formMessage.textContent = 'Error: Could not connect to the RSVP service. Check your Firebase config.';
            formMessage.style.color = 'red';
        }

        // --- GUEST LIST LOGIC ---
        function listenForRsvps() {
            if (unsubscribeFromRsvps) unsubscribeFromRsvps();
            if (!db) return;
            const q = query(collection(db, RSVP_COLLECTION));
            
            unsubscribeFromRsvps = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    guestListContainer.innerHTML = '<p class="text-center text-gray-500">No RSVPs received yet.</p>';
                    totalAttendingEl.textContent = '0';
                    return;
                }
                let totalAttending = 0;
                const rsvpList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    rsvpList.push(data);
                    if (data.attending === 'Yes' && data.guests) {
                        totalAttending += parseInt(data.guests, 10);
                    }
                });
                rsvpList.sort((a, b) => b.submittedAt.toMillis() - a.submittedAt.toMillis());
                guestListContainer.innerHTML = ''; 
                rsvpList.forEach(data => {
                    const listItem = document.createElement('div');
                    listItem.className = 'guest-list-item bg-white p-4 rounded-md flex justify-between items-center';
                    const attendingStatus = data.attending === 'Yes' 
                        ? `<span class="text-xs font-bold uppercase py-1 px-2 rounded-full bg-green-200 text-green-800">${data.guests} Guest(s)</span>`
                        : `<span class="text-xs font-bold uppercase py-1 px-2 rounded-full bg-red-200 text-red-800">Not Attending</span>`;
                    listItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${data.name}</p>
                            <p class="text-xs text-gray-500">Submitted: ${data.submittedAt.toDate().toLocaleString()}</p>
                        </div>
                        ${attendingStatus}
                    `;
                    guestListContainer.appendChild(listItem);
                });
                totalAttendingEl.textContent = totalAttending;
            }, (error) => {
                console.error("Error listening for RSVPs:", error);
                guestListContainer.innerHTML = `<p class="text-center text-red-500">Could not load guest list. Error: ${error.message}</p>`;
            });
        }
        
        // --- AUTHENTICATION ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Authenticated successfully:", user.uid);
                    listenForRsvps();
                } else {
                    if (unsubscribeFromRsvps) unsubscribeFromRsvps();
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        formMessage.textContent = `Authentication Error: ${error.message}`;
                    });
                }
            });
        }

        // --- EVENT DETAILS for Calendar ---
        const eventDetails = {
            title: "Anika Kantheti's Half Saree Ceremony",
            location: "220 Brincefield Place, Cary, NC, 27519",
            description: "Cordially invited to join in the occasion of the Half Saree Ceremony of Anika Kantheti.",
            startUTC: '20250727T223000Z',
            endUTC: '20250728T003000Z',
        };

        // --- UI LOGIC ---
        function setupCalendarLinks() {
            const googleLink = document.getElementById('google-calendar-link');
            const googleUrl = new URL('https://www.google.com/calendar/render');
            googleUrl.searchParams.append('action', 'TEMPLATE');
            googleUrl.searchParams.append('text', eventDetails.title);
            googleUrl.searchParams.append('dates', `${eventDetails.startUTC}/${eventDetails.endUTC}`);
            googleUrl.searchParams.append('details', eventDetails.description);
            googleUrl.searchParams.append('location', eventDetails.location);
            googleLink.href = googleUrl.toString();

            const appleLink = document.getElementById('apple-calendar-link');
            const icsContent = [
                'BEGIN:VCALENDAR', 'VERSION:2.0', 'BEGIN:VEVENT',
                `URL:${document.location.href}`, `DTSTART:${eventDetails.startUTC}`, `DTEND:${eventDetails.endUTC}`,
                `SUMMARY:${eventDetails.title}`, `DESCRIPTION:${eventDetails.description}`, `LOCATION:${eventDetails.location}`,
                'END:VEVENT', 'END:VCALENDAR'
            ].join('\n');
            appleLink.href = `data:text/calendar;charset=utf8,${encodeURIComponent(icsContent)}`;
            appleLink.download = 'anikas-ceremony.ics';
        }

        attendingRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                guestCountWrapper.style.display = (event.target.value === 'Yes') ? 'block' : 'none';
            });
        });

        rsvpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth || !auth.currentUser) {
                formMessage.textContent = "Service not ready. Please try again.";
                formMessage.style.color = 'red';
                return;
            }

            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            formMessage.textContent = '';

            const rsvpData = {
                name: new FormData(rsvpForm).get('name'),
                attending: new FormData(rsvpForm).get('attending'),
                guests: new FormData(rsvpForm).get('attending') === 'Yes' ? parseInt(new FormData(rsvpForm).get('guests') || '1', 10) : 0,
                submittedAt: new Date(),
            };
            
            try {
                const storedDocId = localStorage.getItem('anikaRsvpDocId');
                let docExists = false;

                if (storedDocId) {
                    const docRef = doc(db, RSVP_COLLECTION, storedDocId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        // Document exists, so update it.
                        await updateDoc(docRef, rsvpData);
                        formMessage.textContent = "Thank you! Your RSVP has been updated.";
                        docExists = true;
                    }
                }
                
                if (!docExists) {
                    // Create a new document if one doesn't exist or the stored one was stale.
                    const newDocRef = await addDoc(collection(db, RSVP_COLLECTION), rsvpData);
                    localStorage.setItem('anikaRsvpDocId', newDocRef.id);
                    formMessage.textContent = "Thank you! Your RSVP has been recorded.";
                }

                formMessage.style.color = 'green';
                rsvpForm.reset();
                guestCountWrapper.style.display = 'none';

            } catch (error) {
                console.error("Error submitting RSVP: ", error);
                formMessage.textContent = "An error occurred while submitting. Please try again.";
                formMessage.style.color = 'red';
                // Clear the stale doc ID if it caused an error
                localStorage.removeItem('anikaRsvpDocId'); 
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit RSVP';
            }
        });
        
        toggleGuestListBtn.addEventListener('click', () => {
            const isHidden = guestListContent.classList.toggle('hidden');
            toggleGuestListBtn.textContent = isHidden ? 'Show List' : 'Hide List';
        });

        // --- INITIALIZE PAGE ---
        setupCalendarLinks();

    </script>
</body>
</html>
